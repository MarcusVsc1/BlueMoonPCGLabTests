<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Moon</title>
    <style>
        @font-face {
            font-family: Medieval;
            src: url("font/OldeEnglish.ttf");
        }

        canvas {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>
    <script src="Sprite.js"></script>
    <script src="Scene.js"></script>
    <script src="AssetsManager.js"></script>
    <script src="GameManager.js"></script>
    <script src="Grid.js"></script>
    <script src="Animation.js"></script>
    <script src="DungeonGenerator.js"></script>
    <script src="model/Graph.js"></script>
    <script src="model/Room.js"></script>
    <script src="utils/DrawingUtils.js"></script>
</head>

<body style="background-color: black">
    <canvas></canvas>
    <script>
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("hero", "assets/hero.png");
        assetsMng.loadImage("hud", "assets/hud.png");
        assetsMng.loadImage("bluemoon", "assets/bluemoon.png");
        assetsMng.loadImage("mana", "assets/mana.png");
        assetsMng.loadImage("bruxa", "assets/bruxa.png");
        assetsMng.loadImage("heart", "assets/heart.png");
        assetsMng.loadImage("dad", "assets/dad.png");
        assetsMng.loadImage("people", "assets/people.png");
        assetsMng.loadImage("flame", "assets/flame.png");
        assetsMng.loadImage("object", "assets/object.png");
        assetsMng.loadImage("cenario", "assets/cenario.png");
        assetsMng.loadImage("monster", "assets/monster.png");
        assetsMng.loadImage("expressoes", "assets/expressoes.png");
        assetsMng.loadImage("explosion", "assets/explosion.png");
        assetsMng.loadAudio("explosion", "assets/explosion.mp3");
        assetsMng.loadImage("sword", "assets/sword.png");
        assetsMng.loadImage("crystal", "assets/crystal.png");
        assetsMng.loadImage("key_0", "assets/key_0.png");
        assetsMng.loadImage("key_1", "assets/key_1.png");
        assetsMng.loadImage("key_2", "assets/key_2.png");
        assetsMng.loadImage("key_3", "assets/key_3.png");
        assetsMng.loadImage("door_0", "assets/door_0.png");
        assetsMng.loadImage("door_1", "assets/door_1.png");
        assetsMng.loadImage("door_2", "assets/door_2.png");
        assetsMng.loadImage("door_3", "assets/door_3.png");
        assetsMng.loadImage("gargoyle", "assets/gargoyle.png");
        assetsMng.loadAudio("sword", "assets/sword.ogg");
        assetsMng.loadAudio("sword2", "assets/sword2.ogg");
        assetsMng.loadAudio("explosion", "assets/explosion.mp3");
        assetsMng.loadAudio("shot", "assets/fire.ogg");
        assetsMng.loadAudio("damage", "assets/damage.ogg");
        assetsMng.loadAudio("gameover", "assets/gameover.ogg");
        assetsMng.loadAudio("quest", "assets/quest.ogg");
        assetsMng.loadAudio("heal", "assets/heal.ogg");
        assetsMng.loadAudio("darkness", "assets/darkness.ogg");
        assetsMng.loadAudio("earth", "assets/earth.ogg");
        assetsMng.loadAudio("door", "assets/door.ogg");
        assetsMng.loadAudio("earth2", "assets/earth2.ogg");
        assetsMng.loadAudio("castelo", "assets/tema1.mp3")
        assetsMng.loadAudio("key", "assets/key.ogg")

        var canvas = document.querySelector("canvas");
        canvas.width = 1080;
        canvas.height = 600
        var ctx = canvas.getContext("2d");
        var teclas = {
            esquerda: 0,
            cima: 0,
            direita: 0,
            baixo: 0,
            espada: 0,
        }

        var pc = new Sprite({ x: canvas.width / 2, y: canvas.height / 2, w: 12, h: 12, imgX: 0, imgY: 0, vidas: 7, imagem: "hero", comportar: porTeclasDirecionais(teclas), props: { tipo: "pc" } });

        var gerenciador = new GameManager(pc);

        const farthestRooms = gerenciador.dungeonGenerator.mapGraph.findFarthestRooms()
        var posicao = this.calcularPosicaoMedia(farthestRooms[0].cells) 

        pc.x = posicao.x * 32
        pc.y = posicao.y * 32

        var cena1 = new Scene({ ctx: ctx, w: canvas.width, h: canvas.height, assets: assetsMng, gamer: gerenciador, });
        cena1.adicionar(pc);

        function porTeclasDirecionais(teclas) {
            return function () {
                if (this.charStop <= 0) {
                    if (teclas.esquerda) {
                        this.vx = -this.standardSpd;
                        this.direcao = 1;
                    }
                    if (teclas.direita) {
                        this.vx = +this.standardSpd;
                        this.direcao = 2;
                    }
                    if (teclas.esquerda === teclas.direita) { this.vx = 0; }
                    if (teclas.cima) {
                        this.vy = -this.standardSpd;
                        this.direcao = 3;
                    }
                    if (teclas.baixo) {
                        this.vy = +this.standardSpd;
                        this.direcao = 0;
                    }
                    if (teclas.cima === teclas.baixo) { this.vy = 0; }
                    if (teclas.espada && this.swCD <= 0 && this.globalCD <= 0) {
                        var tiro = new Sprite({
                            x: this.x, y: this.y,
                            imagem: "object", direcao: this.direcao,
                            vm: 0, w: 12, h: 12, imgX: 3, imgY: 1, imune: 0,
                            props: { tipo: "tiro", modelo: "espada" }, desenhar: desenhaEspada, mover: moverEspada, pc: this
                        });
                        this.charStop = 0.2;
                        this.scene.adicionar(tiro);
                        this.swCD = 0.5;
                        this.globalCD = 0.2;
                        assetsMng.play("sword");
                    }

                }
            }
        }

        function persegue(alvo) {
            return function () {
                this.vx = this.vm * Math.sign(alvo.x - this.x);
                this.vy = this.vm * Math.sign(alvo.y - this.y);

                if (this.y < alvo.y + alvo.h / 2) { this.direcao = 0 }
                else {
                    if (this.y > alvo.y - alvo.h / 2) { this.direcao = 3 }
                }
            }
        }

        //direcao => 0: baixo 1: esquerda, 2: direita, 3: cima
        function moverTiro() {

            this.frame += 8 * dt;
            this.vx, this.vy = 0
            switch (this.direcao) {
                case 0:
                    this.vy = this.vm;
                    break;
                case 1:
                    this.vx = -1 * this.vm;
                    break;
                case 2:
                    this.vx = this.vm;
                    break;
                case 3:
                    this.vy = -1 * this.vm;
                    break;
            }
            this.x = this.x + this.vx * dt;
            this.y = this.y + this.vy * dt;
        }
      
        //direcao => 0: baixo 1: esquerda, 2: direita, 3: cima
        function moverEspada() {
            switch (this.direcao) {
                case 0:
                    this.y = this.pc.y + 10;
                    this.x = this.pc.x - 5;
                    break;
                case 1:
                    this.x = this.pc.x - this.w - 10;
                    this.y = this.pc.y - this.h;
                    break;
                case 2:
                    this.x = this.pc.x + this.w;
                    this.y = this.pc.y - this.h;
                    break;
                case 3:
                    this.y = this.pc.y - this.h * 2.5;
                    this.x = this.pc.x - 5;
                    break;
            }
            this.frame = this.frame + 20 * dt;
            if (Math.floor(this.frame) > 4.2) {
                this.scene.toRemove.push(this);
            }
        }


        function moverObjeto() {
            this.spCD = this.spCD - dt;
            this.swCD = this.swCD - dt;
            this.globalCD = this.globalCD - dt;
        }

        function moverRocha() {
            this.frame += 8 * dt;
            this.vx, this.vy = 0;
            this.vm = this.vm + 0.8;
            switch (this.direcao) {
                case 0:
                    this.vy = this.vm;
                    break;
                case 1:
                    this.vx = -1 * this.vm;
                    break;
                case 2:
                    this.vx = this.vm;
                    break;
                case 3:
                    this.vy = -1 * this.vm;
                    break;
            }
            this.x = this.x + this.vx * dt;
            this.y = this.y + this.vy * dt;
        }

        function atirarRochas() {
            if (this.globalCD <= 0) {
                this.charStop = 0.2;
                var tiro = new Sprite({
                    x: this.x, y: this.y,
                    imagem: "object", direcao: this.direcao,
                    vm: 15, w: 12, h: 12, imgX: 0, imgY: 0, imune: 0,
                    props: { tipo: "tiroE", modelo: "rocha" }, desenhar: desenhaTiro, mover: moverRocha,
                });
                this.scene.adicionar(tiro);
                assetsMng.play("earth");
                this.globalCD = 4;
            }
        }

        //cria uma caveira, comportamento do necromante
        function necromancia() {
            if (this.globalCD <= 0) {
                this.globalCD = 3.5;
                this.scene.assets.play("darkness");
                cena1.adicionar(new Sprite({
                    x: this.x, y: this.y, w: 12, h: 12, vm: 29 + Math.random() * 11, imgX: 1, imgY: 1,
                    imagem: "monster", comportar: persegue(pc), props: { tipo: "npc" }
                }))
            }
        }

        function moverBruxa() {
            if (this.imune > 0) {
                this.imune = this.imune - 1 * dt;
            }

            this.mc = (this.x / this.scene.map.SIZE);
            if (this.mc >= 10.4 || this.mc <= 1.6) {
                this.vx = this.vx * -1
            }
            this.x = this.x + this.vx * this.vm * dt;
            this.spCD = this.spCD - dt;
            this.globalCD = this.globalCD - dt;
            this.frame += 8 * dt;

            if (this.vidas == 20) {
                this.scene.dialogo = "\nQual o problema dessa garota?!\""
            }
            if (this.vidas == 5) {
                this.scene.dialogo = "\nEla conseguiu quebrar minha barreira!..._" +
                    "Preciso me recompor!\""
                this.mover = pc.mover;
                this.comportar = persegue(cena1.spritesTP[0]);
            }
        }

        function moverCircular() {
            this.a = this.a + this.va * dt;
            this.frame += 8 * dt;
            this.vx = this.vm * Math.cos(this.a);
            this.vy = this.vm * Math.sin(this.a);
            this.vm = this.vm + 1.2;
            this.x = this.x + this.vx * dt;
            this.y = this.y + this.vy * dt;

            this.spCD = this.spCD - dt;
            this.swCD = this.swCD - dt;
            this.globalCD = this.globalCD - dt;

        }

        function persegue2(alvo) {
            return function () {
                this.vx = this.vm * Math.sign(alvo.x - this.x) - Math.sqrt(this.vm) * 2;
                this.vy = this.vm * Math.sign(alvo.y - this.y) - Math.sqrt(this.vm) * 2;
                this.vm = this.vm + 0.5;

                if (Math.floor(this.frame) > 20) {
                    this.scene.adicionar(new Animation({ x: this.x, y: this.y, imagem: "explosion" }));
                    this.scene.assets.play("explosion");
                    this.scene.toRemove.push(this);
                }

                if (this.y < alvo.y + alvo.h / 2) { this.direcao = 0 }
                else {
                    if (this.y > alvo.y - alvo.h / 2) { this.direcao = 3 }
                }
            }
        }

        addEventListener("keydown", function (e) {
            switch (e.keyCode) {
                case 75:
                    teclas.espada = 1;
                    break;
                case 65:
                    teclas.esquerda = 1;
                    break;
                case 87:
                    teclas.cima = 1;
                    break;
                case 68:
                    teclas.direita = 1;
                    break;
                case 83:
                    teclas.baixo = 1;
                    break;
            }
        });
        addEventListener("keyup", function (e) {
            switch (e.keyCode) {
                case 75:
                    teclas.espada = 0;
                    break;
                case 65:
                    teclas.esquerda = 0;
                    break;
                case 87:
                    teclas.cima = 0;
                    break;
                case 68:
                    teclas.direita = 0;
                    break;
                case 83:
                    teclas.baixo = 0;
                    break;
            }
        });
        var keyPressed = {};
        addEventListener('keydown', function (e) {

            keyPressed[e.key + e.location] = true;

            if (keyPressed.Shift1 == true && keyPressed.Control1 == true) {
                pc.atravessa = 1;
            }

        }, false);

        function passo(t) {
            dt = (t - anterior) / 1000;
            if (assetsMng.progresso() === 100) {
                cena1.passo(dt);
            }
            anterior = t;
            ctx.fillStyle = "black";
            ctx.font = "10px Arial";
            requestAnimationFrame(passo);
        }

        var dt, anterior = 0;
        requestAnimationFrame(passo);

        function desenharCelulas(cells, fillStyle) {
            ctx.fillStyle = fillStyle;
            cells.forEach(element => {
                ctx.fillRect(element.x * 32 - cena1.cameraX, element.y * 32 - cena1.cameraY, 32, 32);
            });
        }

        function addNodeToExtras(idx) {
            console.log(cena1.gamer.dungeonGenerator.graph.nodes[idx].cells)
            cena1.extras.push(...cena1.gamer.dungeonGenerator.graph.nodes[idx].cells)
        }

        function addCorridorToExtras(idx) {
            edge = cena1.gamer.dungeonGenerator.mapGraph.adjacencyList.filter(function (obj) { return obj.fromRoom == idx })[0]
            console.log(edge.cells)
            cena1.extras.push(...edge.cells)
        }

        function removeSceneExtras(idx) {
            let cells = cena1.gamer.dungeonGenerator.mapGraph.nodes[idx].cells;
            cena1.extras.forEach(extra => {
                cells.forEach(pos => {
                    if (extra.x == pos.x && extra.y == pos.y) {
                        cena1.extras.splice(extra);
                    }
                })
            });
        }

        function calcularPosicaoMedia(cells) {
            let somaX = 0;
            let somaY = 0;

            for (const cell of cells) {
                somaX += cell.x;
                somaY += cell.y;
            }

            const mediaX = somaX / cells.length;
            const mediaY = somaY / cells.length;

            return { x: mediaX, y: mediaY };
        }
    </script>
</body>

</html>